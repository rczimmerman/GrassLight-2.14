	PROGRAM GL
C	***************************************************************
C	GrassLight Ver 2.14
C	Computes radiative transfer and carbon balance of seagrass canopies
C
C	Subroutines required:
C	-----------------------------
C		BIODIS - computes biomass distribution from canopy ht and bending angle.
C		EDCALC - computes radiative transfer through the canopy and light absorbed
C				    for photosynthesis.
C		PRODUC - computes whole plant production, respiration and carbon balance.
C         OWQINIT - Optical water quality subroutine, created by CLG to compute 
C                     irradiance at top of seagrass canopy from WQ data, depth and
C                     canopy height.  Additional subroutines are required by OWQINIT
C		
C		Definitions of variables passed between main program and subroutines
C			can be found in each of the subroutines.
C
C		Definitions of common block variables: 
C         ----------------------------------------------------
C         /REGRES/DENSITER(10),PTORITER(10),ITER,RUN
C             used by optimization regression procedure to accumulate
C             iterative values of shoot density, P:R, Iteration # and RUN status (S,O,T)
C
C         Definitions of other common variables can be found in each of the subroutines.
C
C         Files required by GL213 as inputs:
C         ----------------------------------
C             DEFAULT.DAT contains default paramater values and file names required to run GL
C
C
C         Files generated by GL213:
C         ----------------------------------
C             CANHTZ.TXT created by GL to pass data on canopy ht and water depth among subroutines
C             GLRESULT.DAT contains the output results from the latest run; the name of the output file
C                 can be changed by the user through menu option 18.  This file is written to by 
C                 Subroutines EDCALC and PRODUC
C
C
C		Created: 30 Dec 2000                  by:  RCZ
C
C		Date			     Modification		            Version      By
C	---------------  -----------------------------------   --------  --------
C		 22 Jan 01	Shoot:Root ratio now user-modifiable    1.1     RCZ
C		 10 Jul 01	Logistic biomass parameters now	        1.2     RCZ
C					user-modifiable
C		  6 Sep 01	Irradiance output increments now	    1.3	    RCZ
C					user-modifiable
C		  8 Sep 01	MUBARD added to EDCALC subroutine	    1.4	    RCZ
C	     11 Sep 01	EDREF calculation fixed in EDCALC       1.5	    RCZ
C					subroutine
C				    Productivity calcs in EDCALC now
C					handling variable wavelength
C					resolutions
C	     12 Sep 01  MUBARD now user modifiable		        1.51	RCZ
C	     29 Oct 01	Mubard asymptotes to 0.5, not cos(45)   1.52	RCZ
C	     14 Dec 01	Fixed BETA0 problem in writing   	    1.52	RCZ
C					default data file
C	     30 Jan 02	Updated menu descriptions		        1.53	RCZ
C	     31 Jan 02  Added double quotes (" ") to text       1.54    RCZ
C					written to output file for
C					easier parsing by excel etc.
C	     28 Jun 07	Corrected error in MUBARD calculation   1.55	RCZ
C				    in subroutine EDCLC162
C	     14 Jul 07  Corrected error in Eu calculation,      1.56    RCZ
C				    now using EDCLC163
C	     23 Dec 09	Turned off Scalar (PAR) Prod calcs;	    1.60	RCZ
C				    now using Subroutine Prod122
C          15 May 12   Revised to accomodate Intel            2.00    RCZ
C                     FORTRAN 95 Compiler Requirements for
C                     Win7 x64 OS
C          23 May 12  Temperature dependancy added            2.00    RCZ
C           8 Jun 12  Commented out ADVANCE='NO' statements   2.00    CLG
C           5 Jul 12  Allow maximum canopy ht to exceed       2.01    RCZ
C                     water depth, required add'l mods to
C                     OWQINIT and BIODIS
C          10 Jul 12  Routine to find max sustainable density 2.02    RCZ
C                     added; fixed a couple bugs from 2.01
C          14 Jul 12  Convergence of max density routine      2.03    RCZ
C                     improved; DENSTY changed as DENSTY*PTOR
C                     until PTORST<0.0001.  Regression function
C                     added in 2.02 removed.
C         14 Jul 12   Run output routine fixed to accomodate  2.03    RCZ
C                     density optimization routine
C         23 Jul 12   Allow DAYLEN to be determined by E05NM  2.04    RCZ
C                     when called from menu option 12
C         26 Jul 12   Creating new irradiance file now prompts 2.04   RCZ
C                     user to save default settings
C         28 Jul 12   Menu procedure revised to be more robust 2.05   RCZ
C          1 Aug 12   New hierarchical menu created            2.06   RCZ
C                     and ability to change IOP constants added
C                     to OWQINIT
C         7 Aug 12    Height-relative biomass parameters       2.07   RCZ
C                     to 'default.dat' as 0.
C                     Input data for OWQINIT now read from
C                     and written to data files, which can
C                     be named.  Structure of SiteData.txt
C                     modified to anticipate time series calcs
C                     and is no longer compatible with earlier versions
C        20 Aug 12    Light attenuation by leaf epiphytes added    2.08    RCZ
C                     based on data Bulthuis & Woelkerling 1983.  
C                     Also added variable definitions to 
C                     DEFAULT.DAT and water depth to .IRR file
C        22 Oct 12    Epiphytes now attenuate Eu as well as Ed    2.09    RCZ
C                     in EDCLC Ver 2.09
C        29 Oct 12    Data of Bulthuis & Woelkerling re-fit to    2.09    RCZ
C                     force a 0 intercept.
C         7 Jun 13    Rearranged some menu items, inserted        2.10    RCZ
C                     better error checking on data entries
C                     and cleaned up line numbers.  Also 
C                     inserted ALPHA(100) into /PROD/common 
C                     block for future use by other subroutines
C         8 Nov 13    Updated version number to 2.11; all other   2.11    RCZ
C                     changes for this version are in OWQINIT
C         5 May 15    Epiphyte absorbances (D) now can be user-   2.11a   RCZ
C                     defined.  Default value from Bulthuis &
C                     Woekerling (1983).
C        21 May 15    OZONE calculation in E05NM corrected        2.12    RCZ
C                     to operate on radians, not degrees
C         4 Jun 15    Epiphyte absorbance adjusted to be          2.12    RCZ
C                     D = 0.3792 x EPi (mg DW/cm2)
C         4 Jun 15    N Hemisphere restriction on LON             2.13    CLG
C                     removed in E05NM_213.f
C        21 Dec 15    Fixed error in calculaton of MTHETA         2.14    RCZ
C                     in Subroutine E05NM.
C         3 Nov 16    Added loop to compute GL results for        2.14    RCZ
C                     a range of LAI values
C        7 Dec 18     Reports bending angle under flow to         2.14    RCZ
C                            GLRESULT.DAT
C
C	********************************************************************
C
      IMPLICIT REAL*8 (A-Z)	
      INTEGER I,J,K,L,M,N,NLAYER,CHANGE,MENU,OUTINC,ITER,DONE,FINL
      INTEGER OWQFLG,NITER
	CHARACTER ANS,RUN
	CHARACTER*16 IRRFILE,SEDREF,LEAFIOP,OUTFIL,RELATIVE,
     1	USERSUPL,BIOPARAM,RUNTYPE
	CHARACTER*64 OUTHEAD,COPYRITE,VER
      INCLUDE 'CommonE0.f'    !for use with OWQINIT
	INCLUDE 'CommonKd.f'    !for use with OWQINIT
      COMMON /MASS/ASYMP,INFLEC,SHAPE,BETA0,BIOMAS(100)
     1	/AREA/LAI(100)
     2    /PROJEC/LAP(100)
     3	/WAVE/WAVLED(100)
     4    /PROD/PIZ(100),ALPHA(100)
     5    /IRR/EO(100)
     6    /CONVRG/ITER,DONE,FINL,RUN
	DATA COPYRITE/'Copyright (c) 2016 by R. C. Zimmerman
     1 and C. L. Gallegos'/
	DATA RELATIVE/'Height-relative'/
	DATA USERSUPL/'User-supplied'/
      DATA RUNTYPE/'Single Run'/RUN/'S'/
	DATA VER/'2.14'/
      DATA ITER/1/
      DATA OWQFLG/0/
C
C			*** INTRO HEADER ***
C
	WRITE(*,5)VER,COPYRITE
5	FORMAT(20X,'GrassLight Ver ',A64/10X,A64)
C
C			*** READ DEFAULT SETTINGS FILE ***
C
      OUTFIL='GLRESULT.DAT'   
	OPEN(2,FILE='DEFAULT.DAT',STATUS='OLD')
     	READ(2,10)MAXHT
      CANOPYHT=MAXHT/1000.    !for use in OWQINIT; passed in FILE
      TOTALZ=1.               !needed for BIODIS and passed to OWQINIT where it can change
     	READ(2,10)DENSTY
	READ(2,10)AREASH
	READ(2,10)SRR
	READ(2,10)CURVEL
	READ(2,10)PH
	READ(2,10)DAYLEN
	READ(2,10)ASYMP
	READ(2,10)INFLEC
	READ(2,10)SHAPE
      IF(ASYMP.EQ.0.	.AND.	INFLEC.EQ.0.
     1    .AND. SHAPE.EQ.0.)THEN
          BIOPARAM=RELATIVE
	ELSE
		BIOPARAM=USERSUPL
	ENDIF
	READ(2,10)BETA0
	READ(2,10)MUBARD
10	FORMAT(F10.0)
	READ(2,15)OUTINC
15	FORMAT(I10)
	READ(2,20)IRRFILE
	READ(2,20)SEDREF
	READ(2,20)LEAFIOP
20	FORMAT(A16)
      READ(2,10)TEMP
      READ(2,10,END=22)EPI
      DEPI=0.3792*EPI    !From Bulthuis & Woelkerling 1983
      AEPI=1.-10**(-DEPI)       !Epiphyte absorptance
      GO TO 24
C     ******      Error trap for end-of-file reading DEFAULT.DAT ******
C     Necessitated by addition of epiphyte effect to EDCLC
22    EPI=0.    !Epiphyte load, mg/cm^2
c      DEPTH=2.   !DEPTH (M) - removed to OWQINIT subroutine
      WRITE(*,23)
23    FORMAT(//' Epiphyte load not saved in DEFAULT.DAT;',
     1    ' set to = 0 mg/cm^2')
      CHANGE=1
C     ******      End of Error Trap       ****** 
24	CLOSE(2)
C     ****    write canopy ht to file, needed for OWQINIT ****
      OPEN(UNIT=2,FILE='CANHTZ.TXT',STATUS='REPLACE')
      WRITE(2,25)CANOPYHT
25    FORMAT(F10.3,' Canopy ht, m')
      WRITE(2,27)TOTALZ
27    FORMAT(F10.3,' Water depth, m')
      WRITE(2,29)DAYLEN
29    FORMAT(F10.3,' Photoperiod, h')
      CLOSE(UNIT=2)
C     **** close file and continue      

C
C			*** CHANGE PARAMETERS MENU ***
C
30	DONE=0      !Set denstiy convergence flag to 0
      FINL=0      !Set density convergence final flag to 0
      WRITE(*,40)MAXHT,BIOPARAM,DENSTY,AREASH,SRR,BETA0,CURVEL,PH,
     1	TEMP,SEDREF,LEAFIOP,EPI,IRRFILE,DAYLEN,MUBARD,OUTINC,
     2	RUNTYPE,OUTFIL
40	FORMAT(//11X,'1) Canopy height =',14x,F10.0,' mm'/
     1	11X,'2) Shoot biomass distribution =  ',5X,A15/
     2	11X,'3) Shoot density =',14x,F10.0,' shoots/m^2'/
     3	11X,'4) Shoot leaf area =',17x,F10.5,' m^2/shoot'/
     4	11X,'5) Shoot:Root Ratio =',14x,F10.3,/
     5	11X,'6) Bending angle at 0 flow =',6x,F10.2,' deg'/   
     6    11X,'7) Current speed ='15x,F10.1,' cm/s'/
     7    11X,'8) Seawater pH =',18x,F10.2/
     8	11X,'9) Seawater temperature (deg C) =  ',F9.2/
     9	10X,'10) Sediment reflectance from FILE: ',3x,A16/
     1    10X,'11) Leaf optical properties from FILE: ',A16/
     2	10X,'12) Leaf epiphyte load =',12X,F10.3,' mg/cm^2'/
     3	10X,'13) Irradiance and Kd from FILE: ',6x,A16/
     4	10X,'14) Photoperiod =',17x,F10.1,' hours'/
     5	10X,'15) Average cosine (mu-bar) of Ed =',F10.2,/
     6	10X,'16) Write irradiances every',10x,I5,' cm'/
     7    10X,'17) Run Type:',26X,A16/
     8    10X,'18) Results saved in FILE: ',12x,A16/
     9    10x,'19) Quit GL',///)
C      write(*,990)canht
c990   FORMAT('In GL; canopy ht =',g10.3)
      WRITE (*,45)   !,ADVANCE='NO')
45    FORMAT(' Enter MENU number to change parameter or file,',
     1  ' <RET> to continue:')
	READ(*,50)MENU
50	FORMAT(I3)
      IF(MENU.GT.19   .OR.    MENU.LT.0)GO TO 30
C      IF(MENU.EQ.0)GO TO 125
	IF(MENU.EQ.1)THEN   !Change Canopy Height
55		WRITE(*,60)   !,ADVANCE='NO')
60		FORMAT(' New canopy height (mm):')
		READ(*,10)MAXHT
          CANOPYHT=MAXHT/1000.    !convert from mm to m for OWQINIT
		IF(MAXHT.LE.0.)GO TO 55
          OPEN(UNIT=2,FILE='CANHTZ.TXT',STATUS='REPLACE')
          WRITE(2,25)CANOPYHT
          WRITE(2,27)TOTALZ
          WRITE(2,29)DAYLEN
          CLOSE(UNIT=2)
		CHANGE=1
		GO TO 30
	ELSEIF(MENU.EQ.2)THEN   !Change biomass distribution
65		WRITE(*,70)
70		FORMAT(//' 1) Relative to canopy height'/
     1		' 2) User supplied'//' Enter your choice:')
		READ(*,50)MENU
		IF(MENU.LT.1	.OR.	MENU.GT.2)GO TO 65
		IF(MENU.EQ.1)THEN
			ASYMP=0.
			INFLEC=0.
			SHAPE=0.
			BIOPARAM=RELATIVE
			CHANGE=1
			GO TO 30
		ELSE
			WRITE(*,80)   !,ADVANCE='NO')
80			FORMAT(' Asymptote (% biomass) =')
			READ(*,10)ASYMP
			WRITE(*,85)   !,ADVANCE='NO')
85			FORMAT(' Inflection height (mm) =')
			READ(*,10)INFLEC
			WRITE(*,90)   !,ADVANCE='NO')
90			FORMAT(' Shape parameter =')
			READ(*,10)SHAPE
			BIOPARAM=USERSUPL
			CHANGE=1
			WRITE(*,95)ASYMP,INFLEC,SHAPE ! ,ADVANCE='NO')
95            FORMAT(///' New biomass distribution parameters:'/
     1            ' ASYMP = ',G15.5/' INFLEC = ',G15.5,/' SHAPE =',
     2		    G15.5///)
			GO TO 30
		ENDIF
	ELSEIF(MENU.EQ.3)THEN   !Change shoot density
100		WRITE(*,105)   !,ADVANCE='NO')
105		FORMAT(' New shoot density (shoots/m^2):')
		READ(*,10)DENSTY
		IF(DENSTY.LT.0.0)GO TO 100
		CHANGE=1
		GO TO 30
	ELSEIF(MENU.EQ.4)THEN   !Change shoot leaf area
110		WRITE(*,115)   !,ADVANCE='NO')
115		FORMAT(' New shoot leaf area (m^2/shoot):')
		READ(*,10)AREASH
		IF(AREASH.LE.0.0)GO TO 110
		CHANGE=1
		GO TO 30
	ELSEIF(MENU.EQ.5)THEN   !Change shoot:root ratio
120		WRITE(*,125)   !,ADVANCE='NO')
125		FORMAT(' New Shoot:Root ratio:')
		READ(*,10)SRR
          IF(SRR.LE.0.0)GO TO 120
		CHANGE=1
		GO TO 30
      ELSEIF(MENU.EQ.6)THEN   !Change bending angle
130		WRITE(*,135)   !,ADVANCE='NO')
135		FORMAT(' New bending angle at 0 flow (5 deg minimum):')
		READ(*,10)BETA0
          IF(BETA0.LT.5.0)GO TO 130
		CHANGE=1
		GO TO 30 
	ELSEIF(MENU.EQ.7)THEN   !Change current speed
		WRITE(*,140)   !,ADVANCE='NO')
140		FORMAT(' New current speed (cm/s):')
		READ(*,10)CURVEL
		IF(CURVEL.LT.0.)CURVEL=ABS(CURVEL)
		CHANGE=1
		GO TO 30
	ELSEIF(MENU.EQ.8)THEN   !Change pH
145		WRITE(*,150)   !,ADVANCE='NO')
150		FORMAT(' New pH:')
		READ(*,10)PH
          IF(PH.LT.1.0  .OR.    PH.GT.14.0)GO TO 145
		CHANGE=1
		GO TO 30   
	ELSEIF(MENU.EQ.9)THEN !Change water temperature
155      WRITE(*,160)   !,ADVANCE='NO')
160      FORMAT(' New temperature (5 to 30 deg C):')
          READ(*,10)TEMP
          IF(TEMP.GT.30.0 .OR.TEMP.LT.5.0)GO TO 155
          CHANGE=1
          GO TO 30
	ELSEIF(MENU.EQ.10)THEN !Change Sediment reflectance file
		WRITE(*,165)   !,ADVANCE='NO')
165		FORMAT(' New sediment reflectance file:')
		READ(*,20)SEDREF
		CHANGE=1
		GO TO 30
      ELSEIF(MENU.EQ.11)THEN   !Change Leaf Optical Properties File
		WRITE(*,170)   !,ADVANCE='NO')
170		FORMAT(' New leaf optical properties file:')
		READ(*,20)LEAFIOP
		CHANGE=1
		GO TO 30
      ELSEIF(MENU.EQ.12)THEN  !Change epiphyte load
          WRITE(*,175)
175       FORMAT(' New epiphyte load:')
          READ(*,10)EPI   !Epiphyte load, mg/cm^2
          IF(EPI.GE.0.1)THEN  
              ABSEPI=0.3792         !Epiphyte absorbance (per mg/cm2) from Bulthuis & Woelkerling 1983 re-fit for 0 intercept
176           WRITE(*,177)ABSEPI
177           FORMAT(' Enter ephiphyte absorbance, currently ',F7.4,
     1            ' per mg/cm2')
              READ(*,10)ABSNEW
              IF(ABSNEW.GT.0)THEN
                  ABSEPI=ABSNEW
              ELSEIF(ABSNEW.NE.0)THEN !Error trap for negative absorbances
                  GO TO 176           !Go back and get the number again
              END IF
              DEPI=ABSEPI*EPI  
              AEPI=1.0-10.0**(-DEPI)    ! converted to absporptance
          ELSE
              AEPI=0.
          END IF
          CHANGE=1
          GO TO 30    
      ELSEIF(MENU.EQ.13)THEN  !Get existing irradiance file or create new one 
		WRITE(*,180)   !,ADVANCE='NO')
180		FORMAT(' Create new .IRR file?')
          READ(*,260) ANS
          IF(ANS.EQ.'Y'.OR.ANS.EQ.'y') THEN
C             WRITE(*,990)CANHT,DEPTH !debugging stmts
C      		TOTALZ=DEPTH
C      		CANOPYHT=CANHT
c              WRITE(*,1050)CANOPYHT
c1050          FORMAT(' LEAVING GL, CANOPYHT =',G10.3,' m')
c          write(*,1051)canopyht
c1051      format('From GL, Canopy Ht ='f15.3)              
              CALL OWQINIT(IRRFILE)
              OPEN(UNIT=2,FILE='CANHTZ.TXT',STATUS='OLD')
              READ(2,185)CANOPYHT
              READ(2,185)TOTALZ
              READ(2,185)DAYLEN
185           FORMAT(F10.3)
              CLOSE(UNIT=2)
              OWQFLG=1
              CHANGE=1
C              WRITE(*,1052)TOTALZ    !debugging stmts
C1052          FORMAT(' BACK FROM OWQINIT, TOTALZ =',G10.3,
C     1        ' m')
c              pause
              GO TO 30
          END IF
190      WRITE(*,195)   !,ADVANCE='NO')
195      FORMAT(' Name of existing IRR file to load: ')
		READ(*,20)IRRFILE
          IF(IRRFILE.EQ.' ')GO TO 190
		CHANGE=1
          OWQFLG=0
		GO TO 30
      ELSEIF(MENU.EQ.14)THEN    !Change photoperiod    
          IF(OWQFLG.EQ.0)THEN
200		    WRITE(*,205)   !,ADVANCE='NO')
205		    FORMAT(' New photoperiod (h):')
		    READ(*,10)DAYLEN
		    IF(DAYLEN.LE.0)GO TO 200
		    CHANGE=1
              GO TO 30
          ELSE
              WRITE(*,210)
210           FORMAT(' Photoperiod set by OWQINIT, override (Y/N)?')
              READ(*,140)ANS
              IF(ANS.EQ.'Y'   .OR.    ANS.EQ.'y')GO TO 200
          END IF
          GO TO 30
	ELSEIF(MENU.EQ.15)THEN !Change average cosine
215		WRITE(*,220)   !,ADVANCE='NO')
220		FORMAT(' New average cosine for Ed:')
		READ(*,10)MUBARD
          IF(MUBARD.GT.1.0)GO TO 215
          IF(MUBARD.LT.0.0)MUBARD=ABS(MUBARD)
		CHANGE=1
		GO TO 30 
	ELSEIF(MENU.EQ.16)THEN  !Change irradiance output increment
		WRITE(*,225)   !,ADVANCE='NO')
225		FORMAT(' Irradiance output increment (cm):')
		READ(*,15)OUTINC
		CHANGE=1
		GO TO 30
      ELSEIF(MENU.EQ.17)THEN  !Change run type
          WRITE(*,230)
230       FORMAT('Enter:'/'   "S" for single run'/
     1    '   "O" to optimize density'/
     2    '   "M" for multiple runs at specific shoot densities'/
     3    '   "T" for time series run:')
235      READ(*,260)RUN
          IF(RUN.EQ.'S'   .OR.    RUN.EQ.'s')THEN
              RUNTYPE='Single Run'
              CHANGE=1
              GO TO 30
          ELSEIF(RUN.EQ.'O'   .OR.    RUN.EQ.'o')THEN
              RUNTYPE='Optimize Density'
              CHANGE=1
              GO TO 30
          ELSEIF(RUN.EQ.'M'   .OR.    RUN.EQ.'m')THEN
              RUNTYPE='Multiple Density'
2351          WRITE(*,2352)
2352          FORMAT(' Minimum LAI:')
              READ(*,10)MINLAI
              IF(MINLAI   .LE.    0)THEN
                  GO TO 2351
              END IF
2353          WRITE(*,2354)
2354          FORMAT(' Maximum LAI (>minimum LAI):')
              READ(*,10)MAXLAI
              IF(MAXLAI.LE.MINLAI)THEN
                  GO TO 2353
              END IF
2355          WRITE(*,2356)
2356          FORMAT(' LAI Increment:')
              READ(*,10)INCLAI    !LAI increment
              IF(INCLAI   .LE.    0)THEN
                  GO TO 2355
              END IF
              NITER=(MAXLAI-MINLAI)/INCLAI    !NITER is integer; should truncate to nearest whole number
              DENSTY=MINLAI/AREASH    !New initial density
              DENINC=INCLAI/AREASH    !Density Increment for iteration
              
              CHANGE=1
              GO TO 30
          ELSEIF(RUN.EQ.'t'   .OR.    RUN.EQ.'T')THEN
              RUNTYPE='Time Series'
              WRITE(*,240)RUNTYPE
240          FORMAT(A16,' not yet implemented, re-enter',
     1            ' "S", "O" or "M":')
              GO TO 235
          END IF
              RUN='S' !Default to single run if random character entered
          GO TO 30
      ELSEIF(MENU.EQ.18)THEN  !Change output file name
		WRITE(*,245)   !,ADVANCE='NO')
245		FORMAT(' New output file:')
		READ(*,20)OUTFIL
		CHANGE=1
		GO TO 30
      ELSEIF(MENU.EQ.19)THEN  !Quit GL
                GOTO 500
      ENDIF
c      write(*,124)DENSTY
c124   format('leaving menu, density=',f10.3)  
250	IF(CHANGE.EQ.1)THEN
		WRITE(*,255)   !,ADVANCE='NO')
255		FORMAT(' Save new settings to default file (Y/N)?')
		READ(*,260)ANS
260		FORMAT(A1)
		IF(ANS.EQ.'Y'	.OR.	ANS.EQ.'y')THEN
			OPEN(2,FILE='DEFAULT.DAT',STATUS='REPLACE')
              IF(BIOPARAM.EQ.RELATIVE)THEN
                  ASYMP=0.
                  INFLEC=0.
                  SHAPE=0.
			WRITE(2,265)MAXHT,DENSTY,AREASH,SRR,CURVEL,PH,
     1		    DAYLEN,ASYMP,INFLEC,SHAPE,BETA0,MUBARD,OUTINC,
     2		    IRRFILE,SEDREF,LEAFIOP,TEMP,EPI
265	        FORMAT(F10.0,6X,'Canopy Ht mm',/,F10.0,6X,'Shoots per m2',/,
     1        F10.4,6X,'Shoot Leaf area mm/shoot'/,F10.4,6X,
     2        'Shoot:Root',/,F10.4,6X,'Current Velocity cm/s'/,F10.4,6X,
     3        'pH',/,F10.4,6X,'Photoperiod h',/,F10.4,6X,'Asymptote',/,
     4        F10.4,6X,'Inflection point',/,F10.4,6X,'Shape factor',/,
     5        F10.4,6X,'Leaf bending angle deg',/,F10.4,6X,
     6        'Mu-bar down',/,I10,6X,'Output increment cm',/,A16,
     7        'Irradiance file',/,A16,'Sediment reflectance file',/,A16,
     8        'Leaf IOPs',/,F10.4,6X,'Water Temp °C',/,F10.4,6X,
     9        'Epiphyte biomass mg/cm2')
			CLOSE(2)
			CHANGE=0
              ENDIF
          ENDIF
	ENDIF
	WRITE(*,270)
270	FORMAT(' Enter a header line for the output file',
     1	' (64 chars max):')
	READ(*,275)OUTHEAD
275	FORMAT(A64)
      ITER=1  !Initialize iteration counter for optimize density routine
c      write(*,213)iter,densty
c213   format('first iteration,density='f10.3)
      IF(DENSTY.LE.1.)THEN
          DENSTY=10.   !Increase density on iter=1 if necessary
      END IF
280	OPEN(UNIT=3,FILE=OUTFIL,STATUS='REPLACE')
	WRITE(3,275)OUTHEAD
	WRITE(3,285)VER,MAXHT,DENSTY,AREASH,SRR,BETA0,BETA,
     1    MUBARD,CURVEL,PH,TEMP,DAYLEN,IRRFILE,SEDREF,
     2    LEAFIOP
285   FORMAT(/'"GrassLight Ver. "',8X,A64/
     1	' "Run Input Conditions"'/' "Canopy ht (mm)="'F10.0,/
     2	' "Shoot density (shoots/m^2)="',F10.0/
     3	' "Shoot area (m^2/shoot)="',F10.4/
     4	' "Shoor:Root ratio="',F10.4/
     5	' "Bending angle at 0 flow (deg) ="',F10.4/
     5    ' "Bending angle with flow (deg) ="',F10.4/
     6	' "Avg cosine Ed at top of canopy ="',F10.4/
     6	' "Current speed (cm/s) ="',F10.4/
     7	' "Seawater pH="',F10.4/
     8    ' "Water temperature (°C) ="',f10.4/
     9	' "Photoperiod (h)="',F10.4/
     1	' "Irradiance and water column IOPs from "',A16/
     2	' "Sediment reflectance from "',A16/
     3	' "Leaf IOPs from "',A16/)
287   CALL BIODIS(MAXHT,DENSTY,CURVEL,AREASH,NLAYER,BETA,LATHIK)
	IF(NLAYER.GT.100)THEN
		WRITE(*,290)
290		FORMAT(' Canopy too tall; reduce height')
		GO TO 30
	ENDIF
	ORIG=MUBARD !Keep original value of MUBARD
	CALL EDCALC(NLAYER,OUTINC,LATHIK,DENSTY,BETA,MUBARD,
     1	IRRFILE,SEDREF,LEAFIOP,AEPI,HR)
	CALL PRODUC(NLAYER,DENSTY,SRR,PH,DAYLEN,LATHIK,TEMP,PTORSP,HR)
	MUBARD=ORIG !Restore orig value of MUBARD for next run
C
C                 *** Find Maximum Sustainable Density ***
C

      IF(RUN.EQ.'O'   .OR.    RUN.EQ.'o')THEN
          IF(HR.NE.12)THEN
              WRITE(*,305)HR
305           FORMAT(//'Time of day =',F7.3'; must be noon'//)
              GO TO 30
          END IF
          WRITE(*,501)ITER,DENSTY,PTORSP
501       FORMAT('Iteration ',I3,' Density = ',F10.3,' P:R= 'F10.3)
          PTORTST=ABS(PTORSP-1.)
          IF(PTORTST.LE.0.0001)THEN
              DONE=1          ! Set Density convergence flag to 1
              IF(FINL.EQ.1)GO TO 310
          ELSE IF(DENSTY.LT.1)THEN
              DONE=1          ! Set Density convergence flag to 1
              IF(FINL.EQ.1)GO TO 310   
          ELSE
              DENSTY=DENSTY*PTORSP
              ITER=ITER+1
              CLOSE(3)
              GO TO 280
          END IF
      END IF
C
C             *** Perform Multiple Density Runs ***
C
      IF(RUN.EQ.'M'   .OR.    RUN.EQ.'m')THEN
          IF(ITER.LE.NITER)THEN
              DENSTY=DENSTY+DENINC
              ITER=ITER+1
              GO TO 287
          END IF
          DENSTY=MINLAI/AREASH   !re-set density to minimum
          ITER=1          !re-set iteration counter
      END IF
C
C
C             *** End or restart the program ***
C
310   ITER=1         ! Re-set iteration flag to 1
500   CLOSE(3)
      WRITE(*,510)   !,ADVANCE='NO')
510   FORMAT(//' Enter <Q> to quit, <RETURN> to continue:')
	READ(*,260)ANS
	IF(ANS.NE.'Q'	.AND.	ANS.NE.'q')GO TO 30
	STOP
	END